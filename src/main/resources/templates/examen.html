<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen en Curso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
	    /* --- BLOQUEO DE COPIA Y SELECCIÓN --- */
	    body { 
	        background-color: #f4f7f6; 
	        /* Evita selección de texto */
	        -webkit-user-select: none; /* Safari/Chrome */
	        -moz-user-select: none;    /* Firefox */
	        -ms-user-select: none;     /* IE10+ */
	        user-select: none; 
	        /* Evita el menú contextual de 'guardar imagen' o 'copiar' en móviles */
	        -webkit-touch-callout: none;
	    }

	    /* --- ESTILOS DE LA INTERFAZ --- */
	    .timer-header {
	        position: sticky;
	        top: 0;
	        z-index: 1020;
	        background: white;
	        border-bottom: 3px solid #0d6efd;
	        padding: 10px 0;
	    }
	    #timer {
	        font-size: 1.8rem;
	        font-weight: 800;
	        color: #dc3545;
	    }
	    .pregunta-card { display: none; }
	    .pregunta-card.active { display: block; }
	    
	    .btn-option {
	        text-align: left;
	        padding: 15px;
	        font-size: 1.1rem;
	        border-radius: 10px;
	        transition: all 0.2s;
	        /* Aseguramos que el cursor no cambie a 'texto' sobre las etiquetas */
	        cursor: pointer !important;
	    }

	    .btn-check:checked + .btn-option {
	        background-color: #0d6efd;
	        color: white;
	        border-color: #0a58ca;
	    }

	    /* Opcional: Evita que el usuario arrastre imágenes si llegan a poner fotos en las preguntas */
	    img {
	        pointer-events: none;
	    }
	</style>
</head>
<body>

	<div class="timer-header shadow-sm mb-4">
	    <div class="container text-center">
	        <div class="mb-2">
	            <span class="fw-bold text-dark" th:text="${alumno.nombre + ' ' + alumno.apellidoPaterno + ' ' + alumno.apellidoMaterno}"></span>
	            <span class="badge bg-primary ms-2" th:text="${alumno.grupo}"></span>
	        </div>
	        <hr class="my-1 opacity-25">
	        <span class="text-muted text-uppercase small d-block">Tiempo para esta pregunta</span>
	        <span id="timer">02:00</span>
	    </div>
	</div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8">
                
                <form id="examenForm" th:action="@{/examen/guardar}" method="post">
                    
                    <div th:each="progreso, iter : ${preguntas}" 
                         th:id="'p-' + ${iter.index}" 
                         class="card shadow-sm pregunta-card" 
                         th:classappend="${iter.index == 0} ? 'active' : ''">
                        
                        <div class="card-header bg-white border-0 pt-4">
                            <h6 class="text-primary fw-bold">
                                Pregunta <span th:text="${iter.index + 1}"></span> de 25
                            </h6>
                        </div>
                        
                        <div class="card-body">
                            <h4 class="mb-4 fw-normal" th:text="${progreso.pregunta.enunciado}"></h4>
                            
                            <div class="d-grid gap-3">
                                <div th:each="res : ${progreso.pregunta.respuestas}">
                                    <input type="radio" class="btn-check" 
                                           th:name="'preg-' + ${progreso.id}" 
                                           th:id="'res-' + ${res.id}" 
                                           th:value="${res.id}" required>
                                    <label class="btn btn-outline-secondary btn-option w-100 shadow-sm" 
                                           th:for="'res-' + ${res.id}" 
                                           th:text="${res.textoRespuesta}"></label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-white border-0 pb-4 text-end">
                            <button type="button" class="btn btn-primary btn-lg px-5" 
                                    th:if="${!iter.last}" 
                                    onclick="siguientePregunta()">Siguiente</button>

							<button type="button" class="btn btn-danger" th:if="${iter.last}" onclick="finalizarExamen()">
								Finalizar y Enviar
							</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>

	<script th:inline="javascript">
		let segundos = 120;
		/* Extraemos el índice que calculó el controlador */
		/* Thymeleaf inyectará el número aquí */
		let indiceServidor = [[${indiceInicial}]];
	    
	    // 1. Recuperar Paso Actual
		let currentStep = sessionStorage.getItem('examenStep') 
		                      ? parseInt(sessionStorage.getItem('examenStep')) 
		                      : indiceServidor;
	    
	    // 2. Recuperar Tiempo (Si no existe o es inválido, 120)
	    let savedTime = sessionStorage.getItem('examenTimeLeft');
	    let timeLeft = (savedTime !== null && !isNaN(savedTime)) 
	                   ? parseInt(savedTime) 
	                   : segundos;

	    const timerDisplay = document.getElementById('timer');

	    // Función para mostrar la pregunta correcta al cargar (Importante para F5)
	    function inicializarVista() {
	        console.log("Cargando en paso:", currentStep, "con tiempo:", timeLeft);
	        
	        // Ocultamos todas por seguridad
	        document.querySelectorAll('.pregunta-card').forEach(card => card.classList.remove('active'));
	        
	        // Mostramos la que recuperamos del storage
	        const cardActual = document.getElementById('p-' + currentStep);
	        if (cardActual) {
	            cardActual.classList.add('active');
	        } else {
	            // Si por algo falla (ej. step mayor a 20), resetear
	            sessionStorage.setItem('examenStep', 0);
	            document.getElementById('p-0').classList.add('active');
	        }
	    }

	    // Ejecutar al cargar la página
	    inicializarVista();

	    // --- LÓGICA DEL CRONÓMETRO ---
		const countdown = setInterval(() => {
		    let minutes = Math.floor(timeLeft / 60);
		    let seconds = timeLeft % 60;
		    timerDisplay.innerHTML = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
		    
		    // Guardar cada segundo en el storage para que el F5 no lo resetee
		    sessionStorage.setItem('examenTimeLeft', timeLeft);
		    
		    if (timeLeft <= 0) {
		        // Buscamos si existe la siguiente tarjeta (p-1, p-2... hasta p-19)
		        const siguienteExiste = document.getElementById('p-' + (currentStep + 1));
		        
		        if (siguienteExiste) {
		            console.log("Tiempo agotado, pasando a la siguiente...");
		            siguientePregunta();
		        } else {
		            console.log("Tiempo agotado en la última pregunta, finalizando...");
		            // Detenemos el intervalo para que no se ejecute múltiples veces
		            clearInterval(countdown); 
		            finalizarExamen(); // Esta es la función async que guarda y redirige
		        }
		    }
		    timeLeft--;
		}, 1000);

		async function siguientePregunta() {
		    const cardActual = document.getElementById('p-' + currentStep);
		    
		    // 1. Obtener datos para guardar
		    const radioSeleccionado = cardActual.querySelector('input[type="radio"]:checked');
		    const progresoId = cardActual.querySelector('input[type="radio"]').name.replace('preg-', '');
		    const respuestaId = radioSeleccionado ? radioSeleccionado.value : '';

		    // 2. Guardar en la nube (AWAIT)
		    try {
		        await fetch(`/examen/guardar-paso?progresoId=${progresoId}&respuestaId=${respuestaId}`, {
		            method: 'POST'
		        });
		    } catch (error) {
		        console.error("Error al guardar:", error);
		    }

		    // 3. ACTUALIZAR EL TIMER AQUÍ
		    // Reiniciamos la variable local y la del storage ANTES de cambiar de tarjeta
		    timeLeft = segundos; 
		    sessionStorage.setItem('examenTimeLeft', segundos);

		    // 4. Lógica visual de cambio de tarjeta
		    cardActual.classList.remove('active');
		    currentStep++;
		    sessionStorage.setItem('examenStep', currentStep);

		    const siguienteCard = document.getElementById('p-' + currentStep);
		    if (siguienteCard) {
		        siguienteCard.classList.add('active');
		        window.scrollTo(0, 0);
		    } else {
		        // Por si acaso llegara aquí sin pasar por finalizarExamen
		        finalizarExamen();
		    }
		}
		
		// Esta función se ejecuta cuando el usuario da clic en "Finalizar"
		function finalizarForzado() {
		    console.log("Finalizando examen manualmente...");
		    
		    // 1. Detenemos el cronómetro para que no siga ejecutando siguientePregunta()
		    if (typeof countdown !== 'undefined') {
		        clearInterval(countdown);
		    }

		    // 2. Limpiamos el almacenamiento para que no haya basura al recargar
		    sessionStorage.removeItem('examenTimeLeft');
		    sessionStorage.removeItem('examenStep');
		    
		    // El formulario se enviará normalmente después de esto
		    return true; 
		}

	    // --- BLOQUEOS EXTRAS ---
	    history.pushState(null, null, location.href);
	    window.onpopstate = function () {
	        history.go(1);
	    };
		
		function inicializarVista() {
		        // Aseguramos que la vista coincida con el paso
		        document.querySelectorAll('.pregunta-card').forEach(card => card.classList.remove('active'));
		        const cardActual = document.getElementById('p-' + currentStep);
		        if (cardActual) {
		            cardActual.classList.add('active');
		        }
		        window.scrollTo(0, 0);
		}
		
		async function finalizarExamen() {
		    const cardActual = document.getElementById('p-' + currentStep);
		    
		    // 1. Obtener datos de la ÚLTIMA pregunta
		    const radioSeleccionado = cardActual.querySelector('input[type="radio"]:checked');
		    const progresoId = cardActual.querySelector('input[type="radio"]').name.replace('preg-', '');
		    const respuestaId = radioSeleccionado ? radioSeleccionado.value : '';

		    // 2. Guardar la última respuesta y esperar confirmación (AWAIT)
		    try {
		        await fetch(`/examen/guardar-paso?progresoId=${progresoId}&respuestaId=${respuestaId}`, {
		            method: 'POST'
		        });
		        
		        // 3. Una vez guardado, limpiamos storage y redirigimos al cálculo final
		        sessionStorage.clear();
		        window.location.href = "/examen/finalizar-y-calcular"; 
		    } catch (error) {
		        console.error("Error al finalizar:", error);
		        alert("Hubo un error al enviar tu última respuesta. Intenta de nuevo.");
		    }
		}
		    
		inicializarVista();

	    document.addEventListener('contextmenu', e => e.preventDefault());
	</script>
</body>
</html>